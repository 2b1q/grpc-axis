import { Controller, OnModuleInit, Logger, Get, Param } from '@nestjs/common';
import { Client, ClientGrpc, GrpcMethod } from '@nestjs/microservices';
import { grpcVehicleOptions } from 'src/grpc.client';

import {
  Vehicle,
  Driver,
  Snapshot,
  SnapshotData,
  OperationResult,
  VehicleService,
} from './interfaces/vehicle.xploitation.interface';
import { VehicleExploitationService } from './vehicle-exploitation.service';

// common controller for both HTTP and gRPC (HTTP2) requests
@Controller()
export class VehicleExploitationController implements OnModuleInit {
  // inject VehicleExploitationService dependencies trough constructor
  constructor(private vehicleExploitationService: VehicleExploitationService) {}

  // implement vehicle proto file
  @Client(grpcVehicleOptions)
  private readonly client: ClientGrpc;

  private vehicleService: VehicleService;
  private logger = new Logger('VehicleExploitationController');
  private logData(method, data) {
    this.logger.log(
      `call method: ${method} with data  ${JSON.stringify(data)}`,
    );
  }

  // on module init hook => wires up gRPC servece 'VehicleExploitationService'
  onModuleInit() {
    this.vehicleService = this.client.getService<VehicleService>(
      'VehicleExploitationService',
    );
  }

  @GrpcMethod('VehicleExploitationService')
  addVehicle(req: Vehicle, metadata: any | undefined): any {
    let token: string | undefined;
    if (metadata) {
      token = metadata.get('token').pop();
    }
    return this.vehicleExploitationService.addVehicle(req, token);
  }

  @GrpcMethod('VehicleExploitationService')
  addSnapshot(req: Snapshot, metadata: any): Promise<OperationResult> {
    let token: string | undefined;
    if (metadata) {
      token = metadata.get('token').pop();
    }
    return this.vehicleExploitationService.addSnapshot(req, token);
  }

  @Get('api/snaphots')
  getSnaphotsId() {
    return this.vehicleExploitationService.getSnaphots();
  }

  @Get('api/snaphot/:id')
  getSnaphotById(@Param() params) {
    return this.vehicleExploitationService.getSnaphot(params.id);
  }
}
