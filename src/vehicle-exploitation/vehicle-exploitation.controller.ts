import { Controller, OnModuleInit, Logger } from '@nestjs/common';
import { Client, ClientGrpc, GrpcMethod } from '@nestjs/microservices';
import { grpcVehicleOptions } from 'src/grpc.client';

import {
  Vehicle,
  Driver,
  Snapshot,
  SnapshotData,
  OperationResult,
  VehicleService,
} from './interfaces/vehicle.xploitation.interface';
import { VehicleExploitationService } from './vehicle-exploitation.service';

@Controller('vehicle-exploitation')
export class VehicleExploitationController implements OnModuleInit {
  // inject VehicleExploitationService dependencies trough constructor
  constructor(private vehicleExploitationService: VehicleExploitationService) {}

  // implement vehicle proto file
  @Client(grpcVehicleOptions)
  private readonly client: ClientGrpc;

  private vehicleService: VehicleService;
  private logger = new Logger('VehicleExploitationController');
  private logData(method, data) {
    this.logger.log(
      `call method: ${method} with data  ${JSON.stringify(data)}`,
    );
  }

  // on module init hook => wires up gRPC servece 'VehicleExploitationService'
  onModuleInit() {
    this.vehicleService = this.client.getService<VehicleService>(
      'VehicleExploitationService',
    );
  }
  /*
    {"_internal_repr":
      {
        "token":["Pay3h3fyUn2qseV4FIH37tk444sCesa5"],
        "user-agent":["grpc-node/1.22.2 grpc-c/7.0.0 (osx; chttp2; gale)"]},
        "flags":0
      }
  */

  // TODO - add AUTH
  // TODO - add validation
  @GrpcMethod('VehicleExploitationService')
  addVehicle(req: Vehicle, metadata: any | undefined): any {
    let token: string | undefined;
    if (metadata) {
      token = metadata.get('token').pop();
    }
    return this.vehicleExploitationService.addVehicle(req, token);
  }

  // TODO - add AUTH
  // TODO - add validation
  @GrpcMethod('VehicleExploitationService')
  addSnapshot(req: Snapshot, metadata: any): Promise<OperationResult> {
    let token: string | undefined;
    if (metadata) {
      token = metadata.get('token').pop();
    }
    return this.vehicleExploitationService.addSnapshot(req, token);
  }
}
